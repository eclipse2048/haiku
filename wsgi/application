#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
#  application (web-frontend for Haiku / Automatoetry)
#
#  Copyright 2013 Tobias Radloff <mail@tobias-radloff.de>
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
#  MA 02110-1301, USA.
#

from __future__ import division, absolute_import
import os

if "OPENSHIFT_PYTHON_DIR" in os.environ:
	RUNS_ON_OPENSHIFT = True
else:
	RUNS_ON_OPENSHIFT = False

# Virtual Environment fuer Openshift
if RUNS_ON_OPENSHIFT:
	virtenv = os.environ["OPENSHIFT_PYTHON_DIR"] + "/virtenv/"
	os.environ["PYTHON_EGG_CACHE"] = os.path.join(virtenv, "lib/python2.6/site-packages")
	virtualenv = os.path.join(virtenv, "bin/activate_this.py")
	try:
		execfile(virtualenv, dict(__file__=virtualenv))
	except IOError:
		pass

# Zusaetzliche Module erst ab hier importieren wg. Openshift virtenv
import web
import json
import tempfile
from automatoetry import Haiku, GENES_REGEXP

# Initialisierungsvariablen fuer web.py
urls = ("/", "start", "/do", "automatoetry")
render = web.template.render(os.path.abspath(os.path.dirname(__file__)) + "/templates/", base="layout")
web.config.debug = False
app = web.application(urls, globals()) # erzeugt ImportError, falls kein Symlink application.py -> application existiert

if RUNS_ON_OPENSHIFT:
	application = app.wsgifunc()

# erzeuge Session
web.config.session_parameters.cookie_name = "haiku_session_id"
if RUNS_ON_OPENSHIFT:
	sessionsDir = os.environ["OPENSHIFT_DATA_DIR"] + "sessions/"
else:
	sessionsDir = tempfile.gettempdir() + "/sessions/"
session = web.session.Session(app, web.session.DiskStore(sessionsDir))
#if web.config.get('_session') is None:
#	session = web.session.Session(app, web.session.DiskStore(tmpDir))
#	web.config._session = session
#else:
#	session = web.config._session


class start:
	u"""Definiert Formular und GET- und POST-Methoden fuer die
		Startwebseite des Projekts, auf der der User den Genotyp fuer
		Generation 1 bestimmt. Das zugehoerige Template ist
		"templates/start.html".
	"""

	form = web.form.Form(
		web.form.Textbox(
			"seedword",
			web.form.notnull,
			size = 19,
			class_ = "textfield",
			description = "Startwort:"
		),
		web.form.Button("Neues Zufallswort", id = "newSeedword", class_ = "button"),
		web.form.Textbox(
			"genes",
			web.form.notnull,
			web.form.regexp(r"^[a-z ]*$", "Bitte nur Kleinbuchstaben"),
			web.form.regexp(GENES_REGEXP.pattern, "Gene muessen 5, 7, 5 Zeichen enthalten, jeweils durch Leerzeichen getrennt"),
			size = 19,
			maxlength = 19,
			class_ = "textfield",
			description = "Gene:"
		),
		web.form.Button("Neue Gene", id = "newGenes", class_ = "button"),
		web.form.Button("Los", class_ = "los")
	)


	def GET(self):
		u"""Gibt das Formular fuer Gene und Seedwort zurueck, befuellt
			mit Zufallswerten.
		"""
		print "/ GET: Session ID ist", session.session_id, "und session.haiku ist", "haiku" in session #DEBUG
		tmpHaiku, f = Haiku(), self.form()
		f["seedword"].set_value(tmpHaiku.getGenotype()[0])
		f["genes"].set_value(tmpHaiku.getGenotype()[1])
		return render.start(f)


	def POST(self):
		u"""Wird von den Buttons auf "templates/start.html" aufgerufen.
			Je nach Aufrufer wird unterschiedlich verfahren:
			- Neues Seedwort / Neue Gene: Funktion gibt neue
			Zufallswerte zurueck
			- Los-Button (Submit): Funktion erzeugt haiku mit den
			Werten aus dem Formular neu und ruft Seite "do" auf.
		"""
		input = web.input()
		print "/ POST: input ist", input, "und die Session-ID lautet", session.session_id #DEBUG

		# "Los"-Button
		if "caller" not in input:
			f = self.form()
			if not f.validates():
				return render.start(f)
			session.haiku = Haiku(f.d.seedword, f.d.genes)
			raise web.seeother("do")

		# "Neu"-Button: neues Seedwort oder Gene zurueckgeben
		tmpPoem = Haiku()
		if input["caller"] == "newSeedword":
			return tmpPoem.getRandomSeedword()
		elif input["caller"] == "newGenes":
			return tmpPoem.getRandomGenes()


class automatoetry:
	u"""Definiert GET- und POST-Methoden fuer die Hauptwebseite des
		Projekts, auf der der User zwischen den Kindern einer Generation
		entscheidet, welches sich weiter fortpflanzt. Das zugehoerige
		Template ist "templates/automatoetry.html".
	"""

	def GET(self):
		u"""Gibt Seedwort, Gene und Phaenotyp fuer Generation 1 zurueck
			(den Phaenotyp als Liste von Zeilen).
		"""
		print "/do GET: Session-ID ist", session.session_id, "im Verzeichnis", session.store._get_path(session.session_id), "und das Session-Haiku ist", "haiku" in session #DEBUG
		if not "haiku" in session:
			raise web.seeother("/")
		return render.automatoetry(session.haiku)


	def POST(self):
		u"""Erledigt POST-Requests. Sorgt fuer den Wechsel zur neuen
			Generation und gibt zwei neue Kinder zurueck.
		"""
#		if not "haiku" in session:
#			raise web.seeother("/")
		input = web.input()
		print "/do POST: input ist:", input, "und das Session-Haiku lautet", session.haiku #DEBUG

		if input.query == "0": # initialer Ajax-Aufruf Teil 1
			return json.dumps(session.haiku.getPhenotype())
		elif input.query == "1": # initialer Ajax-Aufruf Teil 2
			parent = session.haiku
		elif input.query == "l": # Linkes Kind
			parent = session.haiku.getChildren()[0]
		elif input.query == "r": # Rechtes Kind
			parent = session.haiku.getChildren()[1]
		print "/do POST: Neuer Elter ist", parent #DEBUG

		# neue Kinder erzeugen
		children = parent.procreateN(2)
		for c in children:
			c.getPhenotype()
		if parent != session.haiku:
			session.haiku = parent

		data = [[c.getGenotype()[0], c.getGenotype()[1], c.getPhenotype()] for c in children]
		data.append(str(children[0].getGeneration()))
		print "/do POST: Ajax-Aufruf fertig bearbeitet, Rueckgabedaten sind", data #DEBUG
		return json.dumps(data)


if __name__ == '__main__':
	if RUNS_ON_OPENSHIFT:
		from wsgiref.simple_server import make_server
		httpd = make_server('localhost', 80, application)
		httpd.serve_forever()
	else: # starte lokal mit web.py
		app.run()
